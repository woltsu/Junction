<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="%PUBLIC_URL%/manifest.json">
  <title>Brillian Bus Display</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
    crossorigin=""></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body style="margin: 0 auto">
  <noscript>
    You need to enable JavaScript to run this app.
  </noscript>


  <div id="mapid" style="height: 100vh">
    <div style="position: fixed; right: 10px; z-index: 40000">
      <h1>NEXT STOP:</h1>
      <h2 id="nextStop"></h2>
    </div>
    <div id="root"></div>
    <script>
      var useRoute = true;
      //var uri = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoid29sdHN1IiwiYSI6ImNqYWU3YWRoYzF6MWMyd3FldnVuYzQyeG8ifQ.XjY709a94Z-XOVI6KFp8HA';
      var uri = "https://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png";
      var bus1URL = "https://llb.cloud.tyk.io/llb-bus-api/GetData?busId=9999";
      var mymap;
      var circle;
      var polyLine;
      var stops = [];
      var stopNames = [];

      // Used to compare if the route needs to be drawn again
      var previousLat = 0;
      var previousLon = 0;

      // Fetches bus GPS data every 1 seconds
      setInterval(function () {
        useRoute ? moveBus(route) : getData(renderBus, bus1URL);
      }, 1000);

      // Gets data and calls a callback method
      function getData(callback, burl) {
        $.ajax({
          url: burl,
          headers: { "Authorization": "Bearer 5a07a2f986f30e00015b3cb1ec73a3d31b0b4d0288dbb15c8c9071fc" },
          success: function (data) {
            data = JSON.parse(data);
            callback(data.lat, data.lon);
          }
        });
      }

      // Gets all bus stops for the bus number 55 (direction = 0 || 1)
      function getStops(direction) {
        $.ajax({
          url: "https://api.digitransit.fi/routing/v1/routers/hsl/index/graphql/",
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Access-Control-Allow-Origin": "*",
            "Access-Control-Allow-Methods": "DELETE, HEAD, GET, OPTIONS, POST, PUT",
            "Access-Control-Allow-Headers": "Content-Type, Content-Range, Content-Disposition, Content-Description",
            "Access-Control-Max-Age": "1728000"
          },
          contentType: "json",
          data: JSON.stringify({
            query: "{pattern(id: \"HSL:1023:" + direction + ":01\") {stops{name lat lon}}}"
          }),
          contentType: "json",
          success: function (data) {
            //stops = stops.concat(data.data.pattern.stops);
            drawStops(data.data.pattern.stops);
          },
          error: function (xhr, status, error) {
            console.log(xhr.responseText);
          }
        });
      }

      // Draws the bus stops on the map as circles. Popup can be used to show additional data about the stop.
      function drawStops(data) {
        stops.forEach(function (stop) {
          stop.remove();
        });
        stops = [];
        stopNames = [];
        data.forEach(function (stop) {
          var lat = stop.lat;
          var lon = stop.lon;
          stops.push(L.circleMarker([stop.lat, stop.lon], { radius: 6, color: "red" }).addTo(mymap));
          stopNames.push(stop.name);

          // DEBUG BOUNDS
          /*var bounds = [[lat - 0.00025, lon - 0.0005], [lat + 0.00025, lon + 0.0005]];
          L.rectangle(bounds, { color: "#ff7800", weight: 1 }).addTo(mymap);*/

          // STOP NAME IN BUBBLE
          /*var popup = L.popup({ closeButton: false, autoPan: false, closeOnClick: false })
            .setLatLng([stop.lat, stop.lon])
            .setContent("<p>" + stop.name + "</p>")
            .addTo(mymap);*/
        });
        stops.forEach(function (stop) {
          stop.addTo(mymap);
        });
      }

      var currentIndex = 1;
      var previousStop = "";
      function checkIfBusIsOnStop(busLat, busLon) {
        stops.forEach(function (stop, i) {
          if (previousStop === stopNames[i]) {
            return;
          }
          lat = stop._latlng.lat;
          lon = stop._latlng.lng;
          if (busLat >= (lat - 0.00025) && busLat <= (lat + 0.00025)) {
            if (busLon >= (lon - 0.0005) && busLon <= (lon + 0.0005)) {
              if (currentIndex >= stopNames.length - 1) {
                currentIndex = 1;
                previousStop = stopNames[stopNames.length - 1];
                stopNames = stopNames.reverse();
                stops = stops.reverse();
              } else {
                currentIndex = i + 1;
                previousStop = stopNames[i];
              }
              document.querySelector("#nextStop").innerHTML = stopNames[currentIndex];
            }
          }
          console.log(stopNames[currentIndex]);
        });
      }

      var coords = [];
      // Initializes the map, bus and the polyline. In the end the function calls getStops methods for both directions of the bus.
      function renderMap(latitude, longitude) {
        if (useRoute) {
          latitude = 60.20294343427406;
          longitude = 24.907969236373905;
        }
        mymap = L.map('mapid', {
          center: [latitude, longitude],
          zoom: 17
        });

        mymap.on('click', function (e) {
          var latlng = e.latlng;
          lat = latlng.lat;
          lon = latlng.lng;
          coords.push([lat, lon]);
          var result = "";
          coords.forEach(function (coord) {
            result = result.concat("[" + coord + "]") + "\n";
          });
          console.log(result);
        });

        L.tileLayer(uri, {
          attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
          maxZoom: 18,
          id: 'mapbox.streets',
          accessToken: 'your.mapbox.access.token'
        }).addTo(mymap);

        circle = L.circleMarker([latitude, longitude], { radius: 10, color: "#6666ff" });
        polyLine = L.polyline([[latitude, longitude]], { color: '#6666ff', weight: 4 });

        circle.addTo(mymap);
        polyLine.addTo(mymap);
        getStops(1);
      }

      var index = 0;
      var direction = 1;
      function moveBus(route) {
        if (direction === 1) {
          if (index === route.length) {
            direction = 0;
            getStops(0);
          } else {
            index++;
          }
        } else {
          if (index === 0) {
            direction = 1;
            getStops(1);
          } else {
            index--;
          }
        }
        renderBus(route[index][0], route[index][1]);
      }

      // Checks if the bus has changed it's location. If it has, a new part is added to the polyline
      // and both the bus and the line is redrawn.
      function renderBus(latitude, longitude) {
        var latlng = L.latLng(latitude, longitude);
        if (latitude != previousLat || longitude != previousLon) {
          circle.setLatLng(latlng);
          circle.redraw();
          polyLine.addLatLng(latlng);
          mymap.panTo(latlng);
        }
        previousLat = latitude;
        previousLon = longitude;
        checkIfBusIsOnStop(latitude, longitude);


        // CUSTOM ICON, Maybe for bus stops? 

        /*var myIcon = L.icon({
          iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/SNice.svg/1200px-SNice.svg.png',
          iconSize: [38, 95],
          iconAnchor: [22, 94],
          popupAnchor: [-3, -76],
        });
        L.marker([latitude, longitude], { icon: myIcon }).addTo(mymap);*/
      }

      getData(renderMap, bus1URL);

      var route = [
        [60.20294343427406, 24.907969236373905],
        [60.2029327713246, 24.907497167587284],
        [60.202874125040644, 24.90731477737427],
        [60.20281547865186, 24.90702509880066],
        [60.20277815816806, 24.906671047210693],
        [60.20276216366201, 24.906327724456787],
        [60.20273550613459, 24.906048774719242],
        [60.202682191014766, 24.905780553817753],
        [60.20264487037934, 24.905501604080204],
        [60.20261821275663, 24.905265569686893],
        [60.20261821275663, 24.90512609481812],
        [60.20261821275663, 24.90489006042481],
        [60.20261821275663, 24.904729127883915],
        [60.20261821275663, 24.904536008834842],
        [60.20262887580833, 24.904471635818485],
        [60.20262887580833, 24.904471635818485],
        [60.20262887580833, 24.904471635818485],
        [60.202634207332856, 24.90430533885956],
        [60.202631541570696, 24.904198050498966],
        [60.20261554699317, 24.904047846794132],
        [60.20259155511227, 24.90387082099915],
        [60.20259422087769, 24.9037903547287],
        [60.20259422087769, 24.90355968475342],
        [60.20259422087769, 24.903371930122375],
        [60.20259422087769, 24.903189539909363],
        [60.20258355781472, 24.902991056442264],
        [60.20258355781472, 24.902830123901367],
        [60.20258355781472, 24.902674555778503],
        [60.20258355781472, 24.902572631835938],
        [60.20258355781472, 24.902443885803226],
        [60.20258355781472, 24.90234732627869],
        [60.20256756321381, 24.902148842811584],
        [60.20256223167845, 24.90204691886902],
        [60.202551568605095, 24.901987910270694],
        [60.20254890283621, 24.901944994926456],
        [60.20253823975854, 24.901885986328125],
        [60.20252491090656, 24.90183234214783],
        [60.20252224513552, 24.901773333549503],
        [60.2025275766774, 24.901708960533142],
        [60.20255423437374, 24.901671409606937],
        [60.20260221817262, 24.90153729915619],
        [60.202634207332856, 24.901424646377567],
        [60.20267685949803, 24.90134418010712],
        [60.20277549241757, 24.9011242389679],
        [60.202826141639434, 24.900974035263065],
        [60.20289011949212, 24.90086138248444],
        [60.20294343427406, 24.900673627853397],
        [60.203018074823234, 24.900501966476444],
        [60.203076720849865, 24.900389313697815],
        [60.20323133259946, 24.90032494068146],
        [60.20336461800571, 24.90034103393555],
        [60.203433926202976, 24.90033030509949],
        [60.20355654803945, 24.90033030509949],
        [60.20365517831451, 24.900292754173282],
        [60.20375114262184, 24.90032494068146],
        [60.20396706128711, 24.900292754173282],
        [60.20414032832414, 24.900292754173282],
        [60.20424428810712, 24.900276660919193],
        [60.204369572536066, 24.900249838829044],
        [60.20450018770794, 24.900244474411014],
        [60.2045934839409, 24.900244474411014],
        [60.20460414635063, 24.90007817745209],
        [60.20460414635063, 24.899917244911197],
        [60.20460414635063, 24.899761676788334],
        [60.20460414635063, 24.899493455886844],
        [60.20460414635063, 24.899359345436096],
        [60.2045988151462, 24.899225234985355],
        [60.204657458347306, 24.899187684059147],
        [60.20476141649164, 24.899160861968998],
        [60.204876036627915, 24.899182319641113],
        [60.20496400064698, 24.89913403987885],
        [60.205035971032586, 24.89913403987885],
        [60.20509194789005, 24.89913403987885],
        [60.20521989463408, 24.89911258220673],
        [60.20541714488688, 24.89911258220673],
        [60.2056303870693, 24.89912331104279],
        [60.205995561087384, 24.89914476871491],
        [60.20625677796416, 24.899155497550968],
        [60.20644602562658, 24.899171590805054],
        [60.206624610447655, 24.899209141731266],
        [60.20679253260152, 24.899230599403385],
        [60.20705107772926, 24.899230599403385],
        [60.207218997700096, 24.899230599403385],
        [60.20741090518567, 24.899294972419742],
        [60.20745355114112, 24.899300336837772],
        [60.207602811548554, 24.899300336837772],
        [60.2077893861028, 24.899300336837772],
        [60.207965298282026, 24.899300336837772],
        [60.20798129025152, 24.89963293075562],
        [60.207991951560224, 24.90004062652588],
        [60.208002612865414, 24.9006199836731],
        [60.20798129025152, 24.90100622177124],
        [60.20798129025152, 24.901446104049683],
        [60.20797595959589, 24.901939630508426],
        [60.20800794351674, 24.902647733688358],
        [60.207991951560224, 24.90305542945862],
        [60.207986620906304, 24.90352749824524],
        [60.20803992740639, 24.90382790565491],
        [60.20803992740639, 24.904407262802124],
        [60.20813587888822, 24.905523061752323],
        [60.20819451576674, 24.90676760673523],
        [60.20823716070345, 24.9075722694397],
        [60.20832245041056, 24.90830183029175],
        [60.20837042577336, 24.908913373947147],
        [60.20840240930959, 24.909406900405887],
        [60.20850902087177, 24.91025447845459],
        [60.20857298764276, 24.910930395126346],
        [60.20863695428897, 24.911488294601444],
        [60.2087222429566, 24.91285085678101],
        [60.20878087878696, 24.91354823112488],
        [60.208738234557096, 24.914664030075077],
        [60.20866893756533, 24.914942979812626],
        [60.20862629318992, 24.915382862091068],
        [60.20859964042715, 24.91559743881226],
        [60.20852501257621, 24.915704727172855],
        [60.20843972339577, 24.915779829025272],
        [60.20834377280271, 24.91582274436951],
        [60.20825315254043, 24.91582274436951],
        [60.20817852390116, 24.915651082992557],
        [60.208082572544086, 24.915468692779545],
        [60.20797062893941, 24.915179014205936],
        [60.20775207127685, 24.914889335632328],
        [60.20759748083141, 24.91478204727173],
        [60.20717635143974, 24.914696216583252],
        [60.20709105875265, 24.914739131927494],
        [60.20686716439399, 24.91510391235352],
        [60.20657929797317, 24.916241168975834],
        [60.20635006920181, 24.917002916336063],
        [60.2062114649816, 24.9176037311554],
        [60.20605686727589, 24.918365478515625],
        [60.205987564619576, 24.91860151290894],
        [60.20591293082601, 24.91885900497437],
        [60.205790317796485, 24.919191598892215],
        [60.20565171121129, 24.919223785400394],
        [60.20510261013776, 24.91881608963013],
        [60.20489469568199, 24.918547868728638],
        [60.20467611752568, 24.91830110549927],
        [60.2044415442257, 24.91804361343384],
        [60.20432958819582, 24.917989969253544],
        [60.20416965034755, 24.91811871528626],
        [60.20389242289687, 24.918408393859867],
        [60.20364718127621, 24.918740987777714],
        [60.203567210786204, 24.918880462646488],
        [60.20341260061938, 24.919137954711918],
        [60.20319401258867, 24.919384717941288],
        [60.20305539503412, 24.91955637931824],
        [60.20291144541529, 24.91976022720337],
        [60.20269285404565, 24.9200713634491],
        [60.20253823975854, 24.920146465301517],
        [60.202404950995195, 24.920253753662113],
        [60.202282324854664, 24.92045760154724],
        [60.20217036145655, 24.92083311080933],
        [60.20222900899846, 24.921219348907474],
        [60.20228765643552, 24.92179870605469],
        [60.20236229847656, 24.922420978546146],
        [60.202463598117774, 24.923161268234253],
        [60.202543571297795, 24.92380499839783],
        [60.20257556051526, 24.924234151840214],
        [60.20266086494259, 24.924706220626835],
        [60.20267685949803, 24.92503881454468],
        [60.202724843117544, 24.925403594970707],
        [60.20275150065364, 24.925639629364017],
        [60.20274616914815, 24.925736188888553],
        [60.20268752253067, 24.92585420608521],
        [60.202495587413175, 24.925918579101566],
        [60.202324977477275, 24.925972223281864],
        [60.202026407954726, 24.92621898651123],
        [60.20176515739377, 24.926315546035767],
        [60.2015412266859, 24.926412105560306],
        [60.201125351316655, 24.926637411117557],
        [60.20080544359964, 24.92677688598633],
        [60.2005335195879, 24.926916360855103],
        [60.20026692523186, 24.92706656455994],
        [60.20004831624365, 24.92710947990418],
        [60.19980304588908, 24.92729187011719],
        [60.199568437747466, 24.927356243133545],
        [60.199413808737056, 24.927399158477787],
        [60.19910988062749, 24.92756009101868],
        [60.198805949702944, 24.927678108215336],
        [60.19853400912115, 24.92783904075623],
        [60.1982354051022, 24.927946329116825],
        [60.19799545347517, 24.92809653282166],
        [60.19777682935412, 24.928171634674076],
        [60.197371571033614, 24.928450584411625],
        [60.197350241509696, 24.92855787277222],
        [60.197350241509696, 24.928761720657352],
        [60.19742489478276, 24.92926597595215],
        [60.197579533165325, 24.930113554000858],
        [60.197691512228864, 24.930993318557743],
        [60.197691512228864, 24.93151903152466],
        [60.19779282629042, 24.932130575180057],
        [60.19784614935506, 24.93255972862244],
        [60.19790480462611, 24.933139085769657],
        [60.19799545347517, 24.93360042572022],
        [60.19804344394095, 24.93405103683472],
        [60.198075437545796, 24.934405088424686],
        [60.198091434336526, 24.934587478637695],
        [60.198107431119475, 24.934726953506473],
        [60.1981127633787, 24.93482351303101],
        [60.198000785752626, 24.934887886047367],
        [60.197728838498456, 24.93508100509644],
        [60.19748888316738, 24.935156106948856],
        [60.1971742724084, 24.93531703948975],
        [60.19672101431734, 24.93552088737488],
        [60.19645438898654, 24.93558526039124],
        [60.19617709634467, 24.935703277587894],
        [60.19587847087935, 24.935896396636963],
        [60.19562250403208, 24.935896396636963],
        [60.19535053706944, 24.93584275245667],
        [60.195025240291486, 24.93584275245667],
        [60.19476393398711, 24.93578910827637],
        [60.194609282337154, 24.935810565948486],
        [60.19441196710509, 24.93572473526001],
        [60.19418265331801, 24.935746192932132],
        [60.193948004993686, 24.935681819915775],
        [60.19372935390883, 24.935542345047],
        [60.19354269939124, 24.935359954833988],
        [60.19335604381217, 24.93508100509644],
        [60.193238716904915, 24.934769868850708],
        [60.19314805491658, 24.93451237678528],
        [60.19308939114362, 24.934437274932865],
        [60.19295606399697, 24.934737682342533],
        [60.19280140382836, 24.93520975112915],
        [60.192620077185396, 24.93557453155518],
        [60.192454749079054, 24.935960769653324],
        [60.19217742264364, 24.936658143997196],
        [60.19187342751291, 24.937366247177128],
        [60.191745428720836, 24.93776321411133],
        [60.19152676296306, 24.93842840194702],
        [60.191180094752035, 24.940102100372314],
        [60.19112676085613, 24.940885305404663],
        [60.1911000938757, 24.942473173141483],
        [60.19105742666195, 24.943116903305057],
        [60.19064141842129, 24.945359230041507],
        [60.19016140236164, 24.946475028991703],
        [60.189836054152416, 24.947322607040405],
        [60.18974538276546, 24.94752645492554],
        [60.18959070746854, 24.94716167449951],
        [60.189329357897016, 24.94672179222107],
        [60.188961331503066, 24.94605660438538],
        [60.18825726951405, 24.94503736495972],
        [60.188049248309405, 24.94475841522217],
        [60.18784655971397, 24.94444727897644],
        [60.187665205699425, 24.944221973419193],
        [60.18761453307511, 24.94418442249298],
        [60.18744651276119, 24.943953752517704],
        [60.18735050076717, 24.94381427764893],
        [60.18724115343197, 24.943610429763797],
        [60.187137139775146, 24.943379759788517],
        [60.187046460933665, 24.94308471679688],
        [60.186998454386774, 24.94301497936249],
        [60.18691577628036, 24.943111538887027],
        [60.18686510249932, 24.943127632141117],
        [60.18659839709946, 24.94329929351807],
        [60.186390365383545, 24.943470954895023],
        [60.18617699815176, 24.94356751441956],
        [60.18596896376568, 24.943588972091675],
        [60.18577693085473, 24.94367480278015],
        [60.185616902570956, 24.94353532791138],
        [60.185579562525845, 24.943138360977173],
        [60.185504882308216, 24.94269847869873],
        [60.185451539191625, 24.942387342453006],
        [60.18538219301049, 24.941990375518802],
        [60.185190156667566, 24.941475391387943],
        [60.18513147867211, 24.94132518768311],
        [60.18495010965945, 24.941121339797977],
        [60.18479541176873, 24.940885305404663],
        [60.18464071314911, 24.94069218635559],
        [60.184389993148784, 24.941207170486454],
        [60.18420862004022, 24.94177579879761],
        [60.18398990407681, 24.942398071289066],
        [60.183787190419565, 24.942880868911743],
        [60.18355780240338, 24.94334220886231],
        [60.18336042073464, 24.943878650665287],
        [60.18314169912126, 24.944490194320682],
        [60.182837620311254, 24.94526267051697],
        [60.18252820389482, 24.946110248565674],
        [60.18233081603695, 24.946539402008057],
        [60.18213342699255, 24.947172403335575],
        [60.18197338095037, 24.94756937026978],
        [60.18171730566038, 24.948127269744873],
        [60.1815732624322, 24.94856715202332],
        [60.18142921857217, 24.94891047477722],
        [60.18125849910507, 24.94924306869507],
        [60.18113579393989, 24.94953274726868],
        [60.18087971211821, 24.949629306793216],
        [60.1807196599656, 24.949640035629276],
        [60.180404888456444, 24.949725866317753],
        [60.17992472271571, 24.949704408645633],
        [60.17952457923539, 24.94982242584229],
        [60.179236472910624, 24.94981169700623],
        [60.17907641274916, 24.949768781661987],
        [60.1788149794745, 24.949768781661987],
        [60.1785748858584, 24.94982242584229],
        [60.17818539692576, 24.94983315467835],
        [60.17758248029081, 24.949951171875],
        [60.177208986558014, 24.949983358383182],
        [60.17697421689489, 24.95001554489136],
        [60.17679813854627, 24.95001554489136],
        [60.17639795697063, 24.95001554489136],
        [60.17614717403138, 24.950155019760135],
        [60.17557623551731, 24.950176477432255],
        [60.174647772256186, 24.950230121612552],
        [60.17440231206526, 24.950122833251953],
        [60.17409815232752, 24.949629306793216],
        [60.173964748045265, 24.949607849121094],
        [60.17363923932273, 24.949350357055668],
        [60.173271037043776, 24.948937296867374],
        [60.17314563387614, 24.948813915252686],
        [60.17280677611379, 24.94850277900696],
        [60.17252394727361, 24.948245286941532],
        [60.17225712538089, 24.947912693023685],
        [60.17209703120495, 24.94752645492554],
        [60.17208102174444, 24.94705438613892],
        [60.17208102174444, 24.946614503860477],
        [60.17206501227615, 24.94577765464783],
        [60.172049002800044, 24.945434331893924],
        [60.17203299331612, 24.945144653320312],
        [60.17199563782332, 24.94476914405823],
        [60.171915590195724, 24.944350719451908],
        [60.171915590195724, 24.94405031204224],
        [60.17189424412875, 24.943578243255615],
        [60.17184087890066, 24.942891597747803],
        [60.171638090243235, 24.942612648010254],
        [60.17132323168922, 24.942634105682377],
        [60.171163132962064, 24.942634105682377],
        [60.171099093252764, 24.942655563354496]
      ]
    </script>
  </div>
</body>

</html>